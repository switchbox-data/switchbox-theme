<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">


<meta name="citation_author" content="Juan-Pablo ">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Scoping plan integration analysis;,citation_author=NYSERDA;,citation_publication_date=2022-12;,citation_cover_date=2022-12;,citation_year=2022;,citation_fulltext_html_url=https://www.documentcloud.org/documents/24722671-clcpa-draft-scoping-plan-integration-analysis-revised-2022;,citation_technical_report_institution=New York State Energy Research and Development Authority;">
<meta name="citation_reference" content="citation_title=Residential Solar Tax Credit Reform Act (S3596B/ A6739A);,citation_abstract=Increases the amount of residential solar tax credits.;,citation_author=Pete Harckham;,citation_author=Latrice Walker;,citation_publication_date=2024;,citation_cover_date=2024;,citation_year=2024;,citation_fulltext_html_url=https://www.nysenate.gov/legislation/bills/2023/S3596/amendment/B;,citation_journal_title=NYS Legislature;">
<meta name="citation_reference" content="citation_title=All-Electric Building Act (SS562A/A920);,citation_abstract=Enacts the &amp;amp;amp;quot;all-electric building act&amp;quot;; provides that the state energy conservation construction code shall prohibit infrastructure, building systems, or equipment used for the combustion of fossil fuels in new construction statewide no later than December 31, 2023 if the building is less than seven stories and July 1, 2027 if the building is seven stories or more.;,citation_author=Briant Kavanagh;,citation_author=Emily Gallagher;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://www.nysenate.gov/legislation/bills/2023/S562;,citation_language=en-US;,citation_publisher=NYS Legislature;">
</head>

<body>

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Author</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Juan-Pablo </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Win Climate
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#brooklyn-residents-who-are-highly-energy-burdened-today" id="toc-brooklyn-residents-who-are-highly-energy-burdened-today" class="nav-link active" data-scroll-target="#brooklyn-residents-who-are-highly-energy-burdened-today">Brooklyn residents who are highly energy burdened today</a>
  <ul class="collapse">
  <li><a href="#foreword" id="toc-foreword" class="nav-link" data-scroll-target="#foreword">Foreword</a></li>
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link" data-scroll-target="#executive-summary">Executive Summary</a></li>
  </ul></li>
  <li><a href="#findings" id="toc-findings" class="nav-link" data-scroll-target="#findings">Findings</a>
  <ul class="collapse">
  <li><a href="#rooftop-solar-gap" id="toc-rooftop-solar-gap" class="nav-link" data-scroll-target="#rooftop-solar-gap">Rooftop Solar Gap</a>
  <ul class="collapse">
  <li><a href="#unequal-installation-rates" id="toc-unequal-installation-rates" class="nav-link" data-scroll-target="#unequal-installation-rates">Unequal installation rates</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="notebooks/analysis-preview.html"><i class="bi bi-journal-code"></i>Analysis</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">



  


<section id="brooklyn-residents-who-are-highly-energy-burdened-today" class="level1 page-columns page-full">
<h1>Brooklyn residents who are highly energy burdened today</h1>
<section id="foreword" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="foreword">Foreword</h2>
<p>New York State’s Solar Tax Credit is the largest of several state incentives available to homeowners installing rooftop solar.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The credit can pay for 25% of a residential rooftop solar installation, or $5,000, whichever is less.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;See NY Climate Scoping Plan Integration Analysis <span class="citation" data-cites="cac_scoping_integration_2022">(<a href="#ref-cac_scoping_integration_2022" role="doc-biblioref">NYSERDA 2022</a>)</span></p><p><sup>2</sup>&nbsp;<a href="">§1</a> of S3596/A6739 <span class="citation" data-cites="nysenate_2024">(<a href="#ref-nysenate_2024" role="doc-biblioref">Harckham and Walker 2024</a>)</span> allows residents to receive the full incentive from the state, regardless how much they owe in income tax. Today, a homeowner installing a $20K system that owes $1K in taxes would only receive $1K, not the full $5K they are eligible for.</p><p><sup>3</sup>&nbsp;The All-Electric Building Act of 2023 <span class="citation" data-cites="aeba_2023">(<a href="#ref-aeba_2023" role="doc-biblioref">Kavanagh and Gallagher 2023</a>)</span>, a version of which was enacted in the state’s FY ’23–24 budget.</p></div><p>The <strong>Residential Solar Tax Credit Reform Act</strong> (<a href="">s3596</a>/<a href="">a6739</a>) updates the current tax credit to make it fully refundable, so that low-income homeowners and people living in disadvantaged communities can also benefit from this incentive.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> The Act also increases<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> the tax credit amount to $10,000, which has not been updated since 2006.</p>
<p>The solar-project-by-income percentages in Figure 1 and Section 3.1 are based on the Residential Solar-Adopter Income and Demographic datasets from Lawrence Berkeley National Lab (lbnl), which counts the number of solar projects within each NYS county at each income level.</p>
</section>
<section id="executive-summary" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p>Analyzing solar installation data from nyserda and Lawrence Berkeley National Lab (<em>Table 1</em>), we find that:</p>
<ul>
<li><strong>NY has a large rooftop solar gap</strong>: homeowners with an annual income above $50,000 are <strong>2.5x</strong> more likely to have rooftop solar than those making below $50,000, who don’t always pay enough income tax to claim the full credit.</li>
<li><strong>NY’s solar tax credit is inequitable</strong>: households making less than $50,000 make up <strong>24%</strong> of owner-occupied households in New York State, but have only received <strong>5%</strong> of the state’s residential tax credit subsidies.</li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<p>Table 1: Cost to New York State of implementing Bucks for Boilers, by year<br>
</p>
<table class="table">
<thead>
<tr class="header">
<th>Replacement year</th>
<th>Yearly cost (millions)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2025</td>
<td>$548</td>
</tr>
<tr class="even">
<td>2026</td>
<td>$1534</td>
</tr>
<tr class="odd">
<td>2027</td>
<td>$2,366</td>
</tr>
<tr class="even">
<td>2028</td>
<td>$3,260</td>
</tr>
<tr class="odd">
<td>2029</td>
<td>$4,470</td>
</tr>
<tr class="even">
<td>2030</td>
<td>$4,837</td>
</tr>
</tbody>
</table>
</div></div><p>The following table contains a complete breakdown of our findings:</p>
<table class="table">
<colgroup>
<col style="width: 29%">
<col style="width: 19%">
<col style="width: 24%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Region</th>
<th>Homes with high<br>
energy burdens</th>
<th>Avg. monthly energy<br>
bills of high-burden<br>
home</th>
<th>Avg. monthly savings<br>
for high-burden homes<br>
under NY HEAT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Community District 4</strong><br>
Bushwick</td>
<td>23%</td>
<td>$254</td>
<td>$128</td>
</tr>
<tr class="even">
<td><strong>Community District 11</strong><br>
Bensonhurst &amp; Bath Beach</td>
<td>28%</td>
<td>$256</td>
<td>$123</td>
</tr>
<tr class="odd">
<td><strong>Community District 16</strong><br>
Brownsville &amp; Ocean Hill</td>
<td>35%</td>
<td>$248</td>
<td>$144</td>
</tr>
<tr class="even">
<td><strong>Community District 10</strong><br>
Bay Ridge &amp; Dyker Heights</td>
<td>21%</td>
<td>$279</td>
<td>$140</td>
</tr>
<tr class="odd">
<td><strong>Community District 1</strong><br>
Greenpoint &amp; Williamsburg</td>
<td>18%</td>
<td>$230</td>
<td>$113</td>
</tr>
<tr class="even">
<td><strong>Community District 18</strong><br>
Canarsie &amp; Flatlands</td>
<td>7%</td>
<td>$385</td>
<td>$176</td>
</tr>
<tr class="odd">
<td><strong>Community District 14</strong><br>
Flatbush &amp; Midwood</td>
<td>22%</td>
<td>$265</td>
<td>$123</td>
</tr>
</tbody>
</table>
<p>What could be driving this “two tier” disparity (<em>Fig. 4</em>) in installation rates?</p>
<ol type="1">
<li>High up-front costs. Solar panels are expensive, costing tens of thousands of dollars to install, so lower income people often can’t afford them.</li>
<li>Low creditworthiness.</li>
<li>Exclusion from tax credits.</li>
</ol>
<p>Furthermore, 88% of these highly-burdened homeowners live in single family or low-rise multifamily buildings. Unlike residents of large multifamily buildings, where the savings from rooftop solar get diluted over many units, these households may be able to meaningfully cut their electricity bills by installing panels.</p>
<p>In total, making the tax credit fully refundable could benefit up to 63% of all highly energy-burdened families in New York.</p>
</section>
</section>
<section id="findings" class="level1 page-columns page-full">
<h1>Findings</h1>
<section id="rooftop-solar-gap" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="rooftop-solar-gap">Rooftop Solar Gap</h2>
<p>While <strong>25%</strong> of all homeowners made less than $50,000 a year, these households installed only 10% of solar projects between 2010 and 2022. This is New York State’s <strong>rooftop solar gap</strong>.</p>
<p>If solar was being deployed equitably, we’d expect homeowners with annual incomes under $50,000 to receive a quarter of the state’s rooftop solar projects, not a tenth. Closing the solar gap would require growing these homeowners’ share of the solar installation pie by 2.5x.</p>
<section id="unequal-installation-rates" class="level3">
<h3 class="anchored" data-anchor-id="unequal-installation-rates">Unequal installation rates</h3>
<p>To understand what’s behind New York’s inequitable distribution of rooftop solar, we must examine solar installation rates.</p>
<p>The contrast with higher-income households is striking: those with annual incomes above $50,000 are 2.5x more likely to have panels than those below.</p>
<p>But it is not the case that the higher a household’s income, the more likely they are to have solar panels on their roof. In fact, solar penetration rates are similar for all income buckets above $50,000, ranging from 22 to 27 households per project.’</p>
</section>
<section id="discussion" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="discussion">Discussion</h3>
<p>What could be driving this “two tier” disparity in installation rates?</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-embed-nb-cell">
<div id="cell-fig-yearly-spending" class="cell" data-execution_count="3">
<div class="cell-output cell-output-display">
<div id="fig-yearly-spending" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-yearly-spending-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Yearly tax expenditure, NY solar tax credit
</figcaption>
<div aria-describedby="fig-yearly-spending-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/notebooks-analysis-fig-yearly-spending-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" data-glightbox="description: .lightbox-desc-1"><img src="index_files/figure-html/notebooks-analysis-fig-yearly-spending-output-2.png" class="img-fluid figure-img"></a>
</div>
</figure>
</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-1" href="notebooks/analysis-preview.html#cell-fig-yearly-spending">Source: Analysis</a></div>
</div><p><sup>4</sup>&nbsp;The federal <a href="">Residential Clean Energy Credit</a> administered by the IRS just received a 10-year extension through the Inflation Reduction Act.</p></div><p>High up-front costs: solar panels<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> are expensive, costing tens of thousands of dollars to install, so lower income people often can’t afford them. The rise of solar leases, which allow homeowners to rent solar panels while paying nothing up-front, has significantly lowered up-front cost as an obstacle to adoption, however.</p>
<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">Figure&nbsp;1: Yearly tax expenditure, NY solar tax credit</span>
</div>

</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-nysenate_2024" class="csl-entry" role="listitem">
Harckham, Pete, and Latrice Walker. 2024. <span>“Residential <span>Solar</span> <span>Tax</span> <span>Credit</span> <span>Reform</span> <span>Act</span> (S3596B/ A6739A).”</span> <em>NYS Legislature</em>. <a href="https://www.nysenate.gov/legislation/bills/2023/S3596/amendment/B">https://www.nysenate.gov/legislation/bills/2023/S3596/amendment/B</a>.
</div>
<div id="ref-aeba_2023" class="csl-entry" role="listitem">
Kavanagh, Briant, and Emily Gallagher. 2023. <span>“All-<span>Electric Building Act</span> (<span>SS562A</span>/<span>A920</span>).”</span> Bill. NYS Legislature. <a href="https://www.nysenate.gov/legislation/bills/2023/S562">https://www.nysenate.gov/legislation/bills/2023/S562</a>.
</div>
<div id="ref-cac_scoping_integration_2022" class="csl-entry" role="listitem">
NYSERDA. 2022. <span>“Scoping Plan Integration Analysis.”</span> Government study. <span>New York State Energy Research and Development Authority</span>. <a href="https://www.documentcloud.org/documents/24722671-clcpa-draft-scoping-plan-integration-analysis-revised-2022">https://www.documentcloud.org/documents/24722671-clcpa-draft-scoping-plan-integration-analysis-revised-2022</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"loop":false,"selector":".lightbox","descPosition":"bottom","closeEffect":"zoom","openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>